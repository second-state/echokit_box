<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è“ç‰™æ§åˆ¶é¢æ¿</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@5" rel="stylesheet" type="text/css" />
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
</head>

<body class="bg-base-200 min-h-screen py-8 bg-cover bg-center bg-no-repeat bg-fixed">
    <div class="container mx-auto px-4 max-w-4xl">
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="card-title text-2xl">è“ç‰™æ§åˆ¶é¢æ¿</h2>
                    <div class="flex items-center gap-2">
                        <span class="badge badge-error" id="statusIndicator">â—</span>
                        <span id="connectionStatus">æœªè¿æ¥</span>
                    </div>
                </div>

                <button class="btn btn-primary w-full mb-4" id="connectButton">
                    è¿æ¥è®¾å¤‡
                </button>

                <div id="controlPanel" class="hidden space-y-4">
                    <div class="flex gap-2">
                        <button class="btn btn-outline flex-1" id="loadAllButton">
                            ğŸ”„ åŠ è½½é…ç½®
                        </button>
                        <button class="btn btn-primary flex-1" id="saveAllButton" disabled>
                            ğŸ’¾ ä¿å­˜ä¿®æ”¹
                        </button>
                        <button class="btn btn-warning" id="resetButton">
                            ğŸ”„ é‡å¯
                        </button>
                    </div>

                    <div class="card bg-base-100 border border-base-300">
                        <div class="card-body">
                            <h3 class="card-title text-lg" id="ssidTitle">SSID è®¾ç½®</h3>
                            <label class="form-control">
                                <div class="label">
                                    <span class="label-text">SSID</span>
                                </div>
                                <input type="text" id="ssidInput" placeholder="è¾“å…¥SSID" class="input input-bordered w-full">
                            </label>
                        </div>
                    </div>

                    <div class="card bg-base-100 border border-base-300">
                        <div class="card-body">
                            <h3 class="card-title text-lg" id="passTitle">å¯†ç è®¾ç½®</h3>
                            <label class="form-control">
                                <div class="label">
                                    <span class="label-text">å¯†ç </span>
                                </div>
                                <input type="password" id="passInput" placeholder="è¾“å…¥å¯†ç " class="input input-bordered w-full">
                            </label>
                        </div>
                    </div>

                    <div class="card bg-base-100 border border-base-300">
                        <div class="card-body">
                            <h3 class="card-title text-lg" id="urlTitle">æœåŠ¡å™¨URLè®¾ç½®</h3>
                            <label class="form-control">
                                <div class="label">
                                    <span class="label-text">URL</span>
                                </div>
                                <input type="text" id="serverUrlInput" placeholder="è¾“å…¥æœåŠ¡å™¨URL" class="input input-bordered w-full">
                            </label>
                        </div>
                    </div>

                    <div class="card bg-base-100 border border-base-300">
                        <div class="card-body">
                            <h3 class="card-title text-lg">èƒŒæ™¯å›¾ç‰‡è®¾ç½®</h3>
                            <div class="form-control mb-4">
                                <label class="label">
                                    <span class="label-text">é€‰æ‹©èƒŒæ™¯å›¾ç‰‡ (GIF)</span>
                                </label>
                                <input type="file" class="file-input file-input-bordered w-full" id="backgroundImage"
                                    accept=".gif" onchange="validateAndPreviewFile(this)">
                                <label class="label">
                                    <span class="label-text-alt">åªå…è®¸GIFæ–‡ä»¶ï¼Œæœ€å¤§1MB</span>
                                </label>
                                <div id="fileError" class="text-error text-sm"></div>
                                <div id="bgPreview"
                                    class="hidden mt-2 w-24 h-16 rounded border border-base-300 bg-cover bg-center">
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button class="btn btn-primary flex-1" id="writeBgButton" disabled>è®¾ç½®èƒŒæ™¯</button>
                                <button class="btn btn-outline flex-1" id="clearBgButton">æ¸…é™¤èƒŒæ™¯</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æç¤ºæ¶ˆæ¯å®¹å™¨ -->
    <div class="toast toast-top toast-end z-50" id="toastContainer">
        <div class="alert" id="notificationToast" style="display: none;">
            <span id="toastMessage">æ¶ˆæ¯å†…å®¹</span>
        </div>
    </div>

    <script>
        // å®šä¹‰UUID
        const SERVICE_ID = "623fa3e2-631b-4f8f-a6e7-a7b09c03e7e0";
        const SSID_ID = "1fda4d6e-2f14-42b0-96fa-453bed238375";
        const PASS_ID = "a987ab18-a940-421a-a1d7-b94ee22bccbe";
        const SERVER_URL_ID = "cef520a9-bcb5-4fc6-87f7-82804eee2b20";
        const BACKGROUND_IMAGE_ID = "d1f3b2c4-5e6f-4a7b-8c9d-0e1f2a3b4c5d";
        const RESET_ID = "f0e1d2c3-b4a5-6789-0abc-def123456789";

        // å…¨å±€å˜é‡
        let device = null;
        let server = null;
        let service = null;
        let isConnected = false;
        let toast = null;
        let selectedBackgroundFile = null;

        // DOMå…ƒç´ 
        const connectButton = document.getElementById('connectButton');
        const controlPanel = document.getElementById('controlPanel');
        const statusIndicator = document.getElementById('statusIndicator');
        const connectionStatus = document.getElementById('connectionStatus');
        const loadAllButton = document.getElementById('loadAllButton');
        const saveAllButton = document.getElementById('saveAllButton');
        const resetButton = document.getElementById('resetButton');
        const ssidInput = document.getElementById('ssidInput');
        const passInput = document.getElementById('passInput');
        const serverUrlInput = document.getElementById('serverUrlInput');
        const ssidTitle = document.getElementById('ssidTitle');
        const passTitle = document.getElementById('passTitle');
        const urlTitle = document.getElementById('urlTitle');
        const backgroundImage = document.getElementById('backgroundImage');
        const bgPreview = document.getElementById('bgPreview');
        const fileError = document.getElementById('fileError');
        const writeBgButton = document.getElementById('writeBgButton');
        const clearBgButton = document.getElementById('clearBgButton');
        const notificationToast = document.getElementById('notificationToast');
        const toastMessage = document.getElementById('toastMessage');

        // è·Ÿè¸ªå“ªäº›å­—æ®µè¢«ä¿®æ”¹
        const modifiedFields = {
            ssid: false,
            pass: false,
            url: false
        };

        // æ ‡è®°å­—æ®µä¸ºå·²ä¿®æ”¹
        function markFieldAsModified(fieldName, titleElement) {
            modifiedFields[fieldName] = true;
            if (!titleElement.textContent.endsWith(' *')) {
                titleElement.textContent += ' *';
            }
            updateSaveButtonState();
        }

        // æ¸…é™¤å­—æ®µä¿®æ”¹æ ‡è®°
        function clearFieldModification(fieldName, titleElement) {
            modifiedFields[fieldName] = false;
            titleElement.textContent = titleElement.textContent.replace(' *', '');
            updateSaveButtonState();
        }

        // æ›´æ–°ä¿å­˜æŒ‰é’®çŠ¶æ€
        function updateSaveButtonState() {
            const hasModifications = Object.values(modifiedFields).some(modified => modified);
            saveAllButton.disabled = !hasModifications;
        }

        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(title, message, isError = false) {
            toastMessage.textContent = `${title}: ${message}`;
            notificationToast.classList.remove('alert-success', 'alert-error', 'alert-info');

            if (isError) {
                notificationToast.classList.add('alert-error');
            } else if (title === 'ä¿¡æ¯') {
                notificationToast.classList.add('alert-info');
            } else {
                notificationToast.classList.add('alert-success');
            }

            notificationToast.style.display = 'flex';

            setTimeout(() => {
                notificationToast.style.display = 'none';
            }, 3000);
        }

        // éªŒè¯å¹¶é¢„è§ˆæ–‡ä»¶
        function validateAndPreviewFile(input) {
            const file = input.files[0];
            fileError.textContent = '';
            bgPreview.classList.add('hidden');
            writeBgButton.disabled = true;
            selectedBackgroundFile = null;

            if (file) {
                // æ£€æŸ¥æ–‡ä»¶ç±»å‹
                if (!file.type.startsWith('image/gif')) {
                    fileError.textContent = 'è¯·é€‰æ‹©GIFæ ¼å¼çš„å›¾ç‰‡æ–‡ä»¶';
                    input.value = '';
                    return false;
                }

                // æ£€æŸ¥æ–‡ä»¶å¤§å° (1MB = 1024 * 1024 bytes)
                const maxSize = 1024 * 1024; // 1MB
                if (file.size > maxSize) {
                    fileError.textContent = 'æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡1MB';
                    input.value = '';
                    return false;
                }

                // é¢„è§ˆå›¾ç‰‡
                const reader = new FileReader();
                reader.onload = function (e) {
                    bgPreview.style.backgroundImage = `url(${e.target.result})`;
                    bgPreview.classList.remove('hidden');
                    selectedBackgroundFile = file;
                    writeBgButton.disabled = false;
                };
                reader.readAsDataURL(file);
            }
            return true;
        }

        // åº”ç”¨èƒŒæ™¯å›¾ç‰‡
        function applyBackgroundImage(imageDataUrl) {
            document.body.style.backgroundImage = `url(${imageDataUrl})`;
        }

        // æ¸…é™¤èƒŒæ™¯å›¾ç‰‡
        function clearBackgroundImage() {
            document.body.style.backgroundImage = '';
        }

        // è¿æ¥è®¾å¤‡
        async function connectToDevice() {
            try {
                // è¯·æ±‚è“ç‰™è®¾å¤‡
                device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: [SERVICE_ID] }],
                    optionalServices: [SERVICE_ID]
                });

                // è¿æ¥åˆ°GATTæœåŠ¡å™¨
                server = await device.gatt.connect();
                service = await server.getPrimaryService(SERVICE_ID);

                // æ›´æ–°UIçŠ¶æ€
                isConnected = true;
                updateConnectionStatus();

                // æ˜¾ç¤ºæ§åˆ¶é¢æ¿
                controlPanel.classList.remove('hidden');
                connectButton.textContent = 'æ–­å¼€è¿æ¥';

                // è®¾å¤‡æ–­å¼€è¿æ¥æ—¶çš„å¤„ç†
                device.addEventListener('gattserverdisconnected', handleDisconnection);

                showNotification('æˆåŠŸ', 'å·²æˆåŠŸè¿æ¥åˆ°è®¾å¤‡');

                // è‡ªåŠ¨åŠ è½½æ‰€æœ‰é…ç½®
                await loadAllConfiguration();
            } catch (error) {
                console.error('è¿æ¥å¤±è´¥:', error);
                showNotification('é”™è¯¯', 'è¿æ¥è®¾å¤‡å¤±è´¥: ' + error.message, true);
            }
        }

        // æ–­å¼€è¿æ¥
        async function disconnectFromDevice() {
            if (device && device.gatt.connected) {
                try {
                    await device.gatt.disconnect();
                    showNotification('ä¿¡æ¯', 'å·²æ–­å¼€è®¾å¤‡è¿æ¥');
                } catch (error) {
                    console.error('æ–­å¼€è¿æ¥å¤±è´¥:', error);
                    showNotification('é”™è¯¯', 'æ–­å¼€è¿æ¥å¤±è´¥: ' + error.message, true);
                }
            }
        }

        // å¤„ç†è®¾å¤‡æ–­å¼€è¿æ¥
        function handleDisconnection() {
            isConnected = false;
            updateConnectionStatus();
            controlPanel.classList.add('hidden');
            connectButton.textContent = 'è¿æ¥è®¾å¤‡';
            device = null;
            server = null;
            service = null;
            showNotification('ä¿¡æ¯', 'è®¾å¤‡å·²æ–­å¼€è¿æ¥');
        }

        // æ›´æ–°è¿æ¥çŠ¶æ€UI
        function updateConnectionStatus() {
            if (isConnected) {
                statusIndicator.classList.remove('badge-error');
                statusIndicator.classList.add('badge-success');
                connectionStatus.textContent = 'å·²è¿æ¥';
            } else {
                statusIndicator.classList.remove('badge-success');
                statusIndicator.classList.add('badge-error');
                connectionStatus.textContent = 'æœªè¿æ¥';
            }
        }

        // è¯»å–Characteristicå€¼
        async function readCharacteristic(characteristicId, inputElement) {
            if (!isConnected || !service) {
                showNotification('é”™è¯¯', 'è®¾å¤‡æœªè¿æ¥', true);
                return false;
            }

            try {
                const characteristic = await service.getCharacteristic(characteristicId);
                const value = await characteristic.readValue();

                // å°†ArrayBufferè½¬æ¢ä¸ºå­—ç¬¦ä¸²
                const decoder = new TextDecoder();
                const stringValue = decoder.decode(value);

                // æ›´æ–°è¾“å…¥æ¡†
                inputElement.value = stringValue;
                return true;
            } catch (error) {
                console.error('è¯»å–å¤±è´¥:', error);
                showNotification('é”™è¯¯', 'è¯»å–æ•°æ®å¤±è´¥: ' + error.message, true);
                return false;
            }
        }

        // åŠ è½½æ‰€æœ‰é…ç½®
        async function loadAllConfiguration() {
            if (!isConnected || !service) {
                showNotification('é”™è¯¯', 'è®¾å¤‡æœªè¿æ¥', true);
                return;
            }

            loadAllButton.disabled = true;
            loadAllButton.textContent = 'åŠ è½½ä¸­...';

            try {
                await readCharacteristic(SSID_ID, ssidInput);
                await readCharacteristic(PASS_ID, passInput);
                await readCharacteristic(SERVER_URL_ID, serverUrlInput);

                // æ¸…é™¤æ‰€æœ‰ä¿®æ”¹æ ‡è®°
                clearFieldModification('ssid', ssidTitle);
                clearFieldModification('pass', passTitle);
                clearFieldModification('url', urlTitle);

                showNotification('æˆåŠŸ', 'å·²åŠ è½½æ‰€æœ‰é…ç½®');
            } catch (error) {
                console.error('åŠ è½½é…ç½®å¤±è´¥:', error);
                showNotification('é”™è¯¯', 'åŠ è½½é…ç½®å¤±è´¥', true);
            } finally {
                loadAllButton.disabled = false;
                loadAllButton.textContent = 'ğŸ”„ åŠ è½½é…ç½®';
            }
        }

        // ä¿å­˜æ‰€æœ‰ä¿®æ”¹
        async function saveAllModifications() {
            if (!isConnected || !service) {
                showNotification('é”™è¯¯', 'è®¾å¤‡æœªè¿æ¥', true);
                return;
            }

            saveAllButton.disabled = true;
            saveAllButton.textContent = 'ä¿å­˜ä¸­...';

            try {
                let savedCount = 0;

                if (modifiedFields.ssid) {
                    await writeCharacteristic(SSID_ID, ssidInput.value);
                    clearFieldModification('ssid', ssidTitle);
                    savedCount++;
                }

                if (modifiedFields.pass) {
                    await writeCharacteristic(PASS_ID, passInput.value);
                    clearFieldModification('pass', passTitle);
                    savedCount++;
                }

                if (modifiedFields.url) {
                    await writeCharacteristic(SERVER_URL_ID, serverUrlInput.value);
                    clearFieldModification('url', urlTitle);
                    savedCount++;
                }

                showNotification('æˆåŠŸ', `å·²ä¿å­˜ ${savedCount} é¡¹ä¿®æ”¹`);
            } catch (error) {
                console.error('ä¿å­˜ä¿®æ”¹å¤±è´¥:', error);
                showNotification('é”™è¯¯', 'ä¿å­˜ä¿®æ”¹å¤±è´¥', true);
            } finally {
                saveAllButton.disabled = true;
                saveAllButton.textContent = 'ğŸ’¾ ä¿å­˜ä¿®æ”¹';
            }
        }

        // é‡å¯è®¾å¤‡
        async function resetDevice() {
            if (!isConnected || !service) {
                showNotification('é”™è¯¯', 'è®¾å¤‡æœªè¿æ¥', true);
                return;
            }

            resetButton.disabled = true;
            resetButton.textContent = 'é‡å¯ä¸­...';

            try {
                const characteristic = await service.getCharacteristic(RESET_ID);
                const encoder = new TextEncoder();
                const data = encoder.encode('RESET');
                await characteristic.writeValue(data);
                showNotification('æˆåŠŸ', 'è®¾å¤‡é‡å¯æŒ‡ä»¤å·²å‘é€');
            } catch (error) {
                console.error('é‡å¯å¤±è´¥:', error);
                showNotification('é”™è¯¯', 'è®¾å¤‡ä¸æ”¯æŒæ­¤æ“ä½œï¼Œè¯·é€šè¿‡æŒ‰è®¾å¤‡ä¸Šçš„ k0 æ¥é‡å¯', true);
            } finally {
                resetButton.disabled = false;
                resetButton.textContent = 'ğŸ”„ é‡å¯';
            }
        }

        // å†™å…¥Characteristicå€¼
        async function writeCharacteristic(characteristicId, inputValue) {
            if (!isConnected || !service) {
                throw new Error('è®¾å¤‡æœªè¿æ¥');
            }

            inputValue = inputValue || '';

            try {
                const characteristic = await service.getCharacteristic(characteristicId);
                const encoder = new TextEncoder();
                const data = encoder.encode(inputValue);
                await characteristic.writeValue(data);
            } catch (error) {
                console.error('å†™å…¥å¤±è´¥:', error);
                throw error;
            }
        }

        // å†™å…¥èƒŒæ™¯å›¾ç‰‡æ•°æ®ï¼ˆåˆ†å—ä¼ è¾“ï¼‰
        async function writeBackgroundImage() {
            if (!isConnected || !service) {
                showNotification('é”™è¯¯', 'è®¾å¤‡æœªè¿æ¥', true);
                return;
            }

            if (!selectedBackgroundFile) {
                showNotification('é”™è¯¯', 'è¯·å…ˆé€‰æ‹©èƒŒæ™¯å›¾ç‰‡', true);
                return;
            }

            try {
                const characteristic = await service.getCharacteristic(BACKGROUND_IMAGE_ID);

                // è¯»å–æ–‡ä»¶ä¸ºArrayBuffer
                const arrayBuffer = await selectedBackgroundFile.arrayBuffer();
                const totalSize = arrayBuffer.byteLength;
                const chunkSize = 512; // BLEå†™å…¥é™åˆ¶ä¸º512å­—èŠ‚
                const totalChunks = Math.ceil(totalSize / chunkSize);

                showNotification('ä¿¡æ¯', `å¼€å§‹ä¼ è¾“å›¾ç‰‡ï¼Œå…±${totalChunks}ä¸ªæ•°æ®åŒ…...`);

                // ç¦ç”¨æŒ‰é’®é˜²æ­¢é‡å¤ç‚¹å‡»
                writeBgButton.disabled = true;
                writeBgButton.textContent = 'ä¼ è¾“ä¸­...';

                // åˆ†å—ä¼ è¾“
                for (let i = 0; i < totalChunks; i++) {
                    const start = i * chunkSize;
                    const end = Math.min(start + chunkSize, totalSize);
                    const chunk = arrayBuffer.slice(start, end);



                    // åˆå¹¶åŒ…å¤´å’Œæ•°æ®
                    const packet = new Uint8Array(chunk.byteLength);
                    packet.set(new Uint8Array(chunk), 0);

                    // å†™å…¥æ•°æ®åŒ…
                    await characteristic.writeValue(packet);

                    // æ›´æ–°è¿›åº¦
                    const progress = Math.round(((i + 1) / totalChunks) * 100);
                    writeBgButton.textContent = `ä¼ è¾“ä¸­... ${progress}%`;

                    // å°å»¶æ—¶ç¡®ä¿è®¾å¤‡æœ‰è¶³å¤Ÿæ—¶é—´å¤„ç†
                    await new Promise(resolve => setTimeout(resolve, 50));
                }

                // åº”ç”¨èƒŒæ™¯å›¾ç‰‡
                const reader = new FileReader();
                reader.onload = function (e) {
                    applyBackgroundImage(e.target.result);
                };
                reader.readAsDataURL(selectedBackgroundFile);

                // æ¢å¤æŒ‰é’®çŠ¶æ€
                writeBgButton.disabled = false;
                writeBgButton.textContent = 'è®¾ç½®èƒŒæ™¯';

                showNotification('æˆåŠŸ', `èƒŒæ™¯å›¾ç‰‡è®¾ç½®æˆåŠŸï¼ä¼ è¾“äº†${totalChunks}ä¸ªæ•°æ®åŒ…ï¼Œæ€»å¤§å°${Math.round(totalSize / 1024)}KB`);

            } catch (error) {
                console.error('å†™å…¥èƒŒæ™¯å›¾ç‰‡å¤±è´¥:', error);

                // æ¢å¤æŒ‰é’®çŠ¶æ€
                writeBgButton.disabled = false;
                writeBgButton.textContent = 'è®¾ç½®èƒŒæ™¯';

                showNotification('é”™è¯¯', 'å†™å…¥èƒŒæ™¯å›¾ç‰‡å¤±è´¥: ' + error.message, true);
            }
        }

        // äº‹ä»¶ç›‘å¬
        connectButton.addEventListener('click', async () => {
            if (!isConnected) {
                await connectToDevice();
            } else {
                await disconnectFromDevice();
            }
        });

        loadAllButton.addEventListener('click', () => {
            loadAllConfiguration();
        });

        saveAllButton.addEventListener('click', () => {
            saveAllModifications();
        });

        resetButton.addEventListener('click', () => {
            resetDevice();
        });

        // ç›‘å¬è¾“å…¥æ¡†å˜åŒ–
        ssidInput.addEventListener('input', () => {
            markFieldAsModified('ssid', ssidTitle);
        });

        passInput.addEventListener('input', () => {
            markFieldAsModified('pass', passTitle);
        });

        serverUrlInput.addEventListener('input', () => {
            markFieldAsModified('url', urlTitle);
        });

        writeBgButton.addEventListener('click', () => {
            writeBackgroundImage();
        });

        clearBgButton.addEventListener('click', () => {
            clearBackgroundImage();
            showNotification('ä¿¡æ¯', 'èƒŒæ™¯å›¾ç‰‡å·²æ¸…é™¤');
        });

        // æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒWeb Bluetooth API
        if (!navigator.bluetooth) {
            showNotification('é”™è¯¯', 'æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒWeb Bluetooth APIï¼Œè¯·ä½¿ç”¨Chromeæˆ–Edgeæµè§ˆå™¨', true);
            connectButton.disabled = true;
        }
    </script>
</body>

</html>